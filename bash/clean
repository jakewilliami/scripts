#! /bin/bash
# Script for emptying * directories! 
# Requires homebrew to be installed

BASH_DIR="/Users/jakeireland/bin/scripts/bash/"


#Clean up
clean-exit() {
    [[ -f ${BASH_DIR}/textcolours.txt ]] && \
    rm /Users/jakeireland/bin/scripts/bash/textcolours.txt
    exit $?
}


# Colours
jq -r 'to_entries|map("\(.key)=\(.value|tostring)")|.[]' ${BASH_DIR}/textcolours.json | sed -e 's/=\([^" >][^ >]*\)/="\1"/g' >> ${BASH_DIR}/textcolours.txt && source ${BASH_DIR}/textcolours.txt


# Help
display_help() {
    echo -e "${BWHITE}Usage: [sudo] empt [option...]${NORM}"
    echo
    echo -e "${ITWHITE}The present script will help to clear deprecated files.  ${ITRED}Omitting option altogether will iteratively delete everything in both Trash and Downloads.${NORM}"
    echo
    echo -e "${BBLUE}\t -t | --trash \t\t${BYELLOW}Iteratively ${BRED}deletes everything in ${ULINE}${BBLUE}t${BRED}rash${NORM} ${BYELLOW}(shared and local).${NORM}"
    echo -e "${BBLUE}\t -d | --downloads \t${BYELLOW}Iteratively ${BRED}deletes everything in ${ULINE}${BBLUE}d${BRED}ownloads${NORM}${BRED} folder.${NORM}"
    echo -e "${BBLUE}\t -b | --brew \t${BYELLOW}Updates and then cleans up home${ULINE}${BBLUE}b${BYELLOW}rew${NORM}${BYELLOW}.${NORM}"
    echo -e "${BBLUE}\t -h | --help \t\t${BYELLOW}Shows ${ULINE}${BBLUE}h${BYELLOW}elp${NORM} ${BYELLOW}(present output).${NORM}"
    clean-exit
}


clean_trash() {
    while true; do
        read -p "${BRED}Are you sure you want to delete everything in your trash?${NORM}" yn
        case $yn in
            [Yy]* ) rm -drf ~/Library/Mobile\ Documents/com\~apple\~CloudDocs/.Trash/*
                    rm -drf ~/.Trash* 
                    clean-exit;;
            [Nn]* ) clean-exit;;
            * )     echo "${BYELLOW}Please answer yes or no.${BNORM}";;
        esac
    done 
}


clean_downloads() {
    while true; do
        read -p "${BRED}Are you sure you want to delete everything in your downloads folder?${NORM}" yn
        case $yn in
            [Yy]* ) rm -drf ~/Downloads/* 
                    clean-exit;;
            [Nn]* ) clean-exit;;
            * )     echo "${BYELLOW}Please answer yes or no.${BNORM}";;
        esac
    done
}


clean_all() {
    while true; do
        read -p "${BRED}Are you sure you want to delete everything in your trash and downloads folder?${NORM}" yn
        case $yn in
            [Yy]* ) rm -drf ~/Library/Mobile\ Documents/com\~apple\~CloudDocs/.Trash/*
                    rm -drf ~/.Trash*
                    rm -drf ~/Downloads/* 
                    clean-exit;;
            [Nn]* ) clean-exit;;
            * )     echo "${BYELLOW}Please answer yes or no.${BNORM}";;
        esac
    done
}


opt_err() {
    HELP="${BWHITE}Invalid option.  Use option -h for help.${NORM}"
    echo -e "${HELP}"
}


clean_brew() {  # https://superuser.com/a/975878/1100925
    brew update # Update homebrew
    brew upgrade  # Update outdated formula
    brew cleanup  # Remove outdated formula
    brew doctor  # Check system for potential problems; https://github.com/Homebrew/legacy-homebrew/issues/20598#issuecomment-19686090
    clean-exit
}


# Options
while getopts ":-:tdh" OPTION; do
        case $OPTION in
                -)
                    case $OPTARG in
                        downloads)
                            clean_downloads ;;
                        trash)
                            clean_trash ;;
                        help)
                            display_help ;;
                        brew)
                            clean_brew ;;
                        *)
                            opt_err ;;
                    esac ;;
                t)
                    clean_trash ;;
                d)  
                    clean_downloads ;;
                h)
                    display_help ;;
                b)
                    clean_brew ;;
                *)
                    opt_err ;;
        esac
done


# If no options
[[ -z $1 ]] && clean_all


# Clean up
clean-exit
