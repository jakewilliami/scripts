#! /bin/bash
# Script for emptying * directories! 
# Requires homebrew to be installed

BASH_DIR="${HOME}/bin/scripts/bash/"
TRASH_SHARED_DIR="${HOME}/Library/Mobile Documents/com~apple~CloudDocs/.Trash/"
TRASH_LOCAL_DIR="${HOME}/.Trash/"
DOWNLOADS_DIR="${HOME}/Downloads/"


#Clean up
clean-exit() {
    [[ -f ${BASH_DIR}/textcolours.txt ]] && \
    rm ${BASH_DIR}/textcolours.txt
    exit $?
}


# Colours
jq -r 'to_entries|map("\(.key)=\(.value|tostring)")|.[]' ${BASH_DIR}/textcolours.json | sed -e 's/=\([^" >][^ >]*\)/="\1"/g' >> ${BASH_DIR}/textcolours.txt && source ${BASH_DIR}/textcolours.txt


# Help
display_help() {
    echo -e "${BWHITE}Usage: [sudo] clean [option...]${NORM}"
    echo
    echo -e "${ITWHITE}The present script will help to clear deprecated files.  ${ITRED}Omitting option altogether will iteratively delete everything in both Trash and Downloads.${NORM}"
    echo
    echo -e "${BBLUE}\t -t | --trash \t\t${BYELLOW}Iteratively ${BRED}deletes everything in ${ULINE}${BBLUE}t${BRED}rash${NORM} ${BYELLOW}(shared and local).${NORM}"
    echo -e "${BBLUE}\t -d | --downloads \t${BYELLOW}Iteratively ${BRED}deletes everything in ${ULINE}${BBLUE}d${BRED}ownloads${NORM}${BRED} folder.${NORM}"
    echo -e "${BBLUE}\t -b | --brew \t${BYELLOW}Updates and then cleans up home${ULINE}${BBLUE}b${BYELLOW}rew${NORM}${BYELLOW}.${NORM}"
    echo -e "${BBLUE}\t -h | --help \t\t${BYELLOW}Shows ${ULINE}${BBLUE}h${BYELLOW}elp${NORM} ${BYELLOW}(present output).${NORM}"
    clean-exit
}


size_of_dir() { 
#    du -ach | grep -E "^([0-9]+(\.[0-9]+)?)[BKMGT]\ttotal$"
    NUM_REGEX="^([0-9]+(\.[0-9]+)?)"
    SIZE=$(du -s "${1}" | grep -Eo "${NUM_REGEX}")
    echo "${SIZE}"
    }
    
    
human_readable_bytes() {
    if [[ $1 -ge 0 ]] && [[ $1 -lt 1000 ]]
    then
        SIZE="${1}"
        TYPE="B"
    elif [[ $1 -ge 1000 ]] && [[ $1 -lt 1000000 ]]
    then
        SIZE=$(echo "$((${1} / 1000))")
        TYPE="KB"
    elif [[ $1 -ge 1000000 ]] && [[ $1 -lt 1000000000 ]]
    then
        SIZE=$(echo "$((${1} / 1000000))")
        TYPE="MB"
    elif [[ $1 -ge 1000000000 ]] && [[ $1 -lt 1000000000000 ]]
    then
        SIZE=$(echo "$((${1} / 1000000000))")
        TYPE="GB"
    elif [[ $1 -gt 1000000000000 ]]
    then
        SIZE=$(echo "$((${1} / 1000000000000))")
        TYPE="TB"
    fi
    echo "${SIZE} ${TYPE}"
}


deleted_t() {
    SHARED_BYTES=$(size_of_dir "${TRASH_SHARED_DIR}")
    LOCAL_BYTES=$(size_of_dir "${TRASH_LOCAL_DIR}")
    SIZE_DIRS=$(echo "$((${SHARED_BYTES} + ${LOCAL_BYTES}))")
    SIZE=$(human_readable_bytes ${SIZE_DIRS})
    echo -e "${BGREEN}Deleted ${SIZE} from trash${NORM}"
}


deleted_d() {
    SIZE_DIR=$(size_of_dir "${DOWNLOADS_DIR}")
    SIZE=$(human_readable_bytes ${SIZE_DIR})
    echo -e "${BGREEN}Deleted ${SIZE} from downloads.${NORM}"
}


deleted_all() {
    SHARED_T_BYTES=$(size_of_dir "${TRASH_SHARED_DIR}")
    LOCAL_T_BYTES=$(size_of_dir "${TRASH_LOCAL_DIR}")
    D_BYTES=$(size_of_dir "${DOWNLOADS_DIR}")
    SIZE_DIRS=$(echo "$((${SHARED_T_BYTES} + ${LOCAL_T_BYTES} + ${D_BYTES}))")
    SIZE=$(human_readable_bytes ${SIZE_DIRS})
    echo -e "${BGREEN}Deleted ${SIZE} from trash and downloads. ${NORM}"
}


clean_function() {
    while true; do
        read -p "${1}" yn
        case $yn in
            [Yy]*) 
                    $2 && return 0 ;;
            [Nn]*) 
                    clean-exit && return 1 ;;
            *)     
                    echo "${BYELLOW}Please answer yes or no.${BNORM}";;
        esac
    done
}


clean_trash() {
    TO_BE_REMOVED=$(rm -drf ${TRASH_SHARED_DIR}/*; rm -drf ${TRASH_LOCAL_DIR}/*)
    MSG="${BRED}Are you sure you want to delete everything in your trash?${NORM}"
    clean_function "${MSG}" $TO_BE_REMOVED
}


clean_downloads() {
    TO_BE_REMOVED=$(rm -drf ${DOWNLOADS_DIR}/*)
    MSG="${BRED}Are you sure you want to delete everything in your trash?${NORM}"
    clean_function "${MSG}" $TO_BE_REMOVED 
}


#Are you sure?
clean_all() {
    TO_BE_REMOVED=$(rm -drf ${TRASH_SHARED_DIR}/*; rm -drf ${TRASH_LOCAL_DIR}/*; rm -drf ${DOWNLOADS_DIR}/*)
    MSG="${BRED}Are you sure you want to delete everything in your trash and downloads folder?${NORM}"
    clean_function "${MSG}" $TO_BE_REMOVED
}


opt_err() {
    HELP="${BYELLOW}Invalid option.  Use option -h for help.${NORM}"
    echo -e "${HELP}"
}


clean_brew() {  # https://superuser.com/a/975878/1100925
    brew update # Update homebrew
    brew upgrade  # Update outdated formula
    brew cleanup  # Remove outdated formula
    brew doctor  # Check system for potential problems; https://github.com/Homebrew/legacy-homebrew/issues/20598#issuecomment-19686090
    clean-exit
}


# Options
while getopts ":-:tdh" OPTION; do
        case $OPTION in
                -)
                    case $OPTARG in
                        downloads)
                            clean_downloads && deleted_d ;;
                        trash)
                            clean_trash && deleted_t ;;
                        help)
                            display_help ;;
                        brew)
                            clean_brew ;;
                        *)
                            opt_err ;;
                    esac ;;
                t)
                    clean_trash && deleted_t ;;
                d)  
                    clean_downloads && deleted_d ;;
                h)
                    display_help ;;
                b)
                    clean_brew ;;
                *)
                    opt_err ;;
        esac
done


# If no options
[[ -z $1 ]] && clean_all && deleted_all


# Clean up
clean-exit
